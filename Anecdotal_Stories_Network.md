"-------------------------------------------------"

            极客时间 刘超 《趣谈网络协议》
    
"-------------------------------------------------"

"""第一讲| 为什么要学习网络协议"""

    1、协议三要素：
        
        语法：就是这段内容要符合一定的规则和格式。
                
        语义：就是这段内容要代表某种意义。
        
        顺序：就是先干啥，后干啥。
        
    2、关于域名系统 DNS (Domain Name System)
    
        从域名中解析 ip 地址
        
        DNS 主要由 3 部分组成：
            
            a. 域名解析器(resolver)
            b. 域名空间(domain name space)
            c. 名称服务器(name server)
            
        DNS 服务器获取域名空间的部分信息的方法：
        
            a. 由管理员编辑一个原始区域文件;
            b. 从其他名称服务器哪里复制区域文件;    
            c. 通过向其他DNS服务器查询来获取具有一定时效的缓存信息。
        
        名称服务器的3中主要类型：
        
            a. 主名称服务器：拥有一个区域文件的原始版本的服务器。
            
            b. 次名称服务器：从其他主名称服务器那里复制一个区域文件。是一个只读版本。
                次名称服务器通过区域传输跟随主名称服务器上的区域文件进行变化。
            
            c. 惟高速缓存名称服务器：没有区域文件。它的职责是帮助名称解析器完成名称解析，
                并缓存解析结果，便于以后使用。        
    
    3、域名解析:
    
        TCP/IP 的域名系统是一个有效的、可靠的、通用的、分布式的 名称-地址 映射系统。
        
        域名解析有两种方式：正向解析和反向解析。
            正向解析：根据域名查找对应的IP地址或其他相关信息。
            反向解析：根据主机的IP地址查询其相关信息。    
        
    4、查询域名 && 域名解析：
    
        DNS 查找：
            浏览器查找域名的 IP 地址
            浏览器 DNS 查找顺序一般是这样的：
            浏览器缓存--> 系统缓存 --> 路由器缓存 --> ISP DNS 缓存 --> 递归搜索。
        
        详细过程如下：
                
            a. 浏览器缓存，浏览器会缓存DNS记录一段时间。
                
                操作系统没有设定浏览器存储DNS记录的时间长短，
                不同的浏览器会存储各自的一个固定时间，时长为2~30分钟不等。         
            
            b. 系统缓存。
                
                如果浏览器缓存里面没有找到需要的记录，浏览器会做一个操作系统调用
                (windows 里面是 gethostname),这样就可以获得系统缓存里面的记录。
                
            c. 路由器缓存：
            
                接下来，如果还是没有找到需要的缓存，将前面的查询请求发个路由器，
                它一般会有自己的DNS缓存。
                
            d. 如果还没有，那就去检查 ISP：
                
                每个ISP(网络服务提供商)，都会有自己的本地域名服务器，它会在 URL 第一次
                访问时缓存该域名的指向。下次再访问时，他会从缓存中把这个URL 曾经指向的 IP 调出来。
                
            e. 递归搜索：
            
                如果ISP本地缓存中还没有
                你的ISP的DNS服务器会从根域名开始进行递归查询。        
            
                递归查询：主机向本地域名服务器的查询一般都是采用递归查询。                
                迭代查询：本地域名服务器向根域名服务器的查询通常是采用迭代查询。
                
                举个栗子：假设的主机想知道另一个主机（域名为 my.xxsilence.net)的IP地址。
                具体步骤如下：
                
                    ① 主机先向其本地域名服务器进行递归查询，如果缓存中没有，继续下一步。
                    ② 本地域名服务器采用迭代查询，先向一个根域名服务器查询。           
                    ③ 根域名服务器告诉本地域名服务器，下一次查询的顶级域名服务器 dns.net。                   
                    ④ 本地域名服务器向顶级域名服务器 dns.net。                  
                    ⑤ 顶级域名服务器 dns.net，下一次应查询的权限域名服务器dns.xxsilence.net的IP地址。                    
                    ⑥ 本地域名服务器向权限域名服务器dns.xxsilence.net进行查询。                 
                    ⑦ 权限域名服务器dns.xxsilence.net告诉本地域名服务器，所查询的主机的IP地址。                
                    ⑧ 本地域名服务器最后把查询结果告诉主机。

    5、互联网在世界运行中，都使用了那些协议：
    
        你在浏览器中里面输入 Https://www.kaola.com， 这是个 URL。
        浏览器只知道名字是“www.kaola.com”,但是不知道具体的地点，所以不知道该如何访问。
        于是，它打开地址簿去查找。可以使用一般地址薄协议DNS去查找，还可以使用另一种更
        精准的地址薄去查找协议HTTPDNS。
        
        无论使用哪种方法查找，最终都会得到这个地址：106.114.138.24 这是个地址，是互联网
        世界的“门牌号”。
        
        知道了目标地址，浏览器就开始打包它的请求。对于普通的浏览器请求，往往会使用 HTTP 协议；
        但是对于购物的请求，往往需要进行加密传输，因而会使用 HTTPS 协议。无论是什么协议，里面
        都会写明“你要买什么和买了多少”。
        
                ------------------------------------
                HTTP头:  POST,URL,HTTP 1.1, 
                         正文格式：json, 正文长度: 1234
                -------------------------------------
                         我要买什么，买多少
                -------------------------------------         
                              
        DNS、HTTP、HTTPS 所在的层我们成为应用层。经过应用层封装后，
        浏览器会将应用层的包交给下一层取完成，通过 socket 编程来实现。
        
        下一层是 传输层。传输层有两种协议，一种是无连接的协议 UDP，一种是面向连接的协议 TCP。
        所谓的面向连接就是，TCP 会保证这包能够到达目的地。如果不能到达，就会重新发送，直到到达。
        
        TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商服务器监听的端口。操作系统
        往往通过端口来判断，它得到的包应该给那个进程。
                
                -----------------------------------
                TCP头：   浏览器端口：12345
                          电商应用端口：443
                ------------------------------------
                HTTP头:  POST,URL,HTTP 1.1, 
                         正文格式：json, 正文长度: 1234
                -------------------------------------
                         我要买什么，买多少
                -------------------------------------
                
        传输层封装完毕后，浏览器会将包交给操作系统的网络层。网络层的协议是 IP 协议。
        在 IP 协议里会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址，也即
        电商网站所在服务器的 IP 地址。
        
                ---------------------------------------
                IP 头：   客户端电脑IP: 192.168.1.101
                          电商服务器IP: 106.114.138.24
                ---------------------------------------
                TCP头：   浏览器端口：12345
                          电商应用端口：443
                ---------------------------------------
                HTTP头:  POST,URL,HTTP 1.1, 
                         正文格式：json, 正文长度: 1234
                ---------------------------------------
                         我要买什么，买多少
                ---------------------------------------
                
        操作系统既然知道了目标 IP 地址，就开始想如何根据这个门牌号找到目标机器。
        操作系统往往会判断，这个目标 IP 地址是本地人，还是外地人。从门牌号就可以开出来。
        但是，显然电商网站不是本地，而是在遥远的远方。
        
        操作系统知道要离开本地去远方，虽然不知道远方在何处，但是可以这样类比一下：
        如果去国外要去海关，去外地就要去网关。而操作系统启动的时候，就会被 DHCP 协议
        配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1
        
        操作系统如何将 IP 地址发给网关呢？在本地通信基本靠吼，于是操作系统会大吼一声，
        谁是 192.168.1.1啊 ?，网关就会答应它，我就是，我的本地地址在村东头。
        这个本地地址就是 MAC 地址，而大吼的那一声是 ARP 协议。
        
                
                MAC 头：  客户端电脑MAC: 192.168.1.101 的MAC
                          网关的MAC: 102.168.1.1 的MAC
                ---------------------------------------
                IP 头：   客户端电脑IP: 192.168.1.101
                          电商服务器IP: 106.114.138.24
                ---------------------------------------
                TCP头：   浏览器端口：12345
                          电商应用端口：443
                ---------------------------------------
                HTTP头:  POST,URL,HTTP 1.1, 
                         正文格式：json, 正文长度: 1234
                ---------------------------------------
                         我要买什么，买多少
                ---------------------------------------
        
        于是操作系统将 IP 包交个了下一层，也就是 MAC 层。网卡
        再将包发出去，由于这个包里面是有 MAC 地址的，因而它能够到达网关。
        
        网关收到包之后，会根据自己的知识，判断下一步应该怎么走，网关往往
        是一个路由器，到某个 IP 地址应该怎么走，这个叫做路由表。
        
        路由器有点像玄奘西行路上的一个个国家的一个个城关。每个城关都连着两个国家，
        每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。
        
        一旦跨过网关，就需要拿出 IP 头来，里面写着贫僧来自东土大唐（就是源IP地址），
        欲往西天求经(目的IP地址)。路过宝地，借宿一晚，请问接下来该怎么走？
        
        城关往往直到这些“知识的”，因为城关和临近的城关也会经常沟通，到哪里应该怎么走，
        这种沟通的协议就是“路由协议”，常用的有 OSPF 和 BGP。
        
        城关和城关之间是一个国家，当网络包知道了下一步去哪个城关，还是要使用国家内部的 MAC地址。
        通过下一个城关的 MAC 地址，找到下一个城关，然后再问下一步的路怎么走，一直走到最后一个城关。
        
        最后一个城关知道这个网络包要去地方，于是，对着这个国家吼一声，谁是目标 IP 啊？目标服务器
        就会回复一个 MAC 地址，网络包过关后，通过这个 MAC 地址就能找到目标服务器。
        
        目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也
        对上了，就取下 IP 头，IP 头里会写上一层封装的 TCP 协议，然后将其交给传输层，即 TCP 层。
        
        在这一层里，对于收到的每个包，都会有一个回复的包说明收到了。这个回复的包绝非这次下单
        的结果，仅仅是 TCP 层的一个说明，即收到的回复。这个回复会沿着刚才的方向走回去，报个平安。
        
        因为一旦出了国门，西行路上千难万险，如果在这个过程中，网络包走丢了，因而到了要报个平安，
        如果过一段时间还没有到，发送端的 TCP 层会重新发生这个包，还是上面的过程，直到有一天
        收到平安到达的回复。这个重试绝非你的浏览器重新将下单这个动作重新请求一次。对于浏览器
        来讲，就发送一次下单请求，TCP层不断自己闷头重试。除非 TCP 这一层出了问题，例如连接
        断了，才轮到浏览器的应用层重新发送下单请求。
        
        当网络平安到达了 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商网站
        的进程正在监听这个端口号，假设一个 Tomcat, 将这个包发给电商网站。
        
        电商网站的进程得到 HTTP 请求内容，知道了要买的内容，往往一个电商网站最初接待请求的这个
        Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都自己做。
        例如，这个接待员要告诉专门管理订单的进程，登录买某个商品，买多少，要告诉管理库存的进程，
        库存要减少多少，要告诉支付的进程等等。
        
        如何告诉相关进程呢？往往通过 RPC 调用，即远程过程调用的方式来实现。
        远程过程调用就是当告诉管理订单进程的时候，接待员不用关心中间网络互连问题，
        会由 RPC 框架统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，
        有的直接封装在 TCP 报文里面的。
        
        当接待员发现相应的部分都处理完毕，就回复一个 HTTPS 的包，告知下单成功。
        这个 HTTPS 的包，告知下单成功。这个 HTTPS 的包，就像来的时候一样，经过
        千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。
        
    6、小结：
    
        一个简简单单的过程，中间牵扯到这么多协议。而管理一大片机器，更是一件特别
        有技术含量的事情。
        
        应用层：DHCP、DNS、HTTP、HTTPS、RTMP、P2P、GTP、RPC等等
        
        传输层：UDP、TCP
        
        网络层：IP、ICMP、OSPF、BGF、GRE、IPSec
        
        链路层：ARP、VLAN、STP
        
        物理层：网络跳线
        
    7、问题：
    
        当网络到达一个城关的时候，可以通过路由表得到下一个城关的 IP 地址，
        直接同过 IP 地址找就可以了，为什么还要通过本地的 MAC 地址呢？
        
        ip 是网络层使用的，MAC 是链路层使用的，ip包最终还是要通过物理链路和MAC地址进行交互的。 
            
"""第二讲| 网络分层的真实含义是什么"""

    1、网络为什么要分层？
    
        那么 TCP 在三次握手的时候，IP 层和 MAC 层在做什么呢？
        当然是 TCP 发送每一个消息，都会带着 IP层 和 MAC 层。
        因为，TCP 每发送一个消息， IP 层和 MAC 层的所有机制
        都要运行一遍。
        
        记住一点：只要是在网络上跑的包，都是完整的。可以有下层没有上层，
        绝对不可能有上层没下层。
        所以，对于TCP 协议来说，三层握手也好，重试也好，只要想发出包，
        就要有 IP层和 MAC 层，不然是发不出去的。
        
    2、二层设备和三层设备：
    
        所谓的二层设备和三层设备，都是这些设备上跑的程序不同而已。
        二层设备收进去的是整个网络包，这里面 HTTP、TCP、IP、MAC都有。
        什么叫二层设备呀，就是只把MAC头摘下来，看看到底是丢弃、转发，还是自己留着。
        那什么叫三层设备呢？就是把 MAC 头摘下来之后，再把 IP 头摘下来，看看是
        丢弃、转发、还是自己留着。
    
    3、小结：
    
        理解网络协议工作模式有两个小窍门：
        
            （1） 始终想象自己是一个处理网络包的程序：
                  如何拿到网络包，如何根据规则进行处理，如何发出去。
            
            （2） 始终牢记一个原则：
                  只要是在网络上跑的包，都是完整的。可以有下层没有上层，
                  绝对不可能有上层没有下层。
                  
                         




"""第三讲| ifconfig: 熟悉又陌生的命令行"""

"""第四讲| DHCP 与 PXE: IP是怎么来的，又是怎么没的"""

"""第五讲| """